name: Proxy Read-Only Test

on:
  push:
    branches:
      - main
    paths:
      - 'src/Aviationexam.DependencyUpdater.Repository.GitHub.Proxy/**'
      - '.github/workflows/proxy-*.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'src/Aviationexam.DependencyUpdater.Repository.GitHub.Proxy/**'
      - '.github/workflows/proxy-*.yml'

permissions:
  contents: read

defaults:
  run:
    working-directory: src/Aviationexam.DependencyUpdater.Repository.GitHub.Proxy

jobs:
  readonly-rejection-test:
    name: Verify Read-Only Token Rejected
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run CLI with read-only token (should fail)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_APP_ID: ${{ secrets.PROXY_GITHUB_APP_ID }}
          GITHUB_APP_KEY_BASE64: ${{ secrets.PROXY_GITHUB_APP_KEY_BASE64 }}
        run: |
          set +e
          OUTPUT=$(bun run src/cli.ts --owner "${{ github.repository_owner }}" --repository "${GITHUB_REPOSITORY#*/}" 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          set -e

          if [ $EXIT_CODE -eq 0 ]; then
            echo "::error::CLI should have failed with read-only token but succeeded"
            exit 1
          fi

          if echo "$OUTPUT" | grep -q "write access"; then
            echo "CLI correctly rejected read-only token"
            exit 0
          else
            echo "::error::CLI failed but not with expected 'write access' error"
            exit 1
          fi
